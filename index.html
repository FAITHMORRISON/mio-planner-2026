<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<link rel="apple-touch-icon" sizes="180x180" href="https://cdn-icons-png.flaticon.com/512/2675/2675848.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://cdn-icons-png.flaticon.com/512/2675/2675848.png">
<title>PLANNER 2026</title>
<style>
body {
  font-family: -apple-system, system-ui, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  background:#fdfbf5; color:#4a4a4a; font-size: 16px; line-height: 1.5; max-width: 800px; margin: 20px auto; padding: 0 15px;
}
/* Titolo Aggiornato */
h1 { 
  text-align:center; 
  margin-top: 40px;
  margin-bottom:40px; 
  color:#4a4a4a; 
  font-size: 1.8rem; 
  letter-spacing: 3px; 
  font-weight: 300;
  text-transform: uppercase;
}

h2,h3,h4,h5 {
  cursor:pointer; padding: 12px 15px; border-radius:10px; margin: 10px 0;
  transition: all 0.2s ease; border-bottom: 1px solid rgba(0,0,0,0.05); line-height: 1.3;
  display: flex; justify-content: space-between; align-items: center;
}
h2:hover, h3:hover, h4:hover, h5:hover { transform: translateY(-1px); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

h2[data-color="salute"] { background:#f0e3cf; }
h2[data-color="vita"] { background:#e2ded6; }
h2[data-color="acquisti"] { background:#d9e2d0; }
h2[data-color="lifestyle"] { background:#f5f2e7; }
h2[data-color="viaggi"] { background:#fef7e5; }
h2[data-color="eventi"] { background:#e3e7de; }
h2[data-color="libero"] { background:#fdf9f0; }
h3 { background:#e0d8c4; margin-left:10px; }
h4 { background:#d0dec4; margin-left:20px; }
h5 { background:#f0efe5; margin-left:30px; }

.title-text { flex-grow: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; margin-right: 10px; }

.delete-cat-btn { 
    background: rgba(244, 180, 180, 0.6); color: #721c24; 
    padding: 4px 8px; font-size: 12px; border-radius: 6px; border:none; flex-shrink: 0;
}

ul { list-style:none; padding-left:10px; margin:5px 0; }
.collapsible-content { display:none; }
li { padding: 8px 0; display:flex; align-items:center; flex-wrap: wrap; border-bottom: 1px solid #eee; }
button { margin: 4px 2px; padding: 8px 12px; font-size: 14px; border-radius:8px; border:none; background:#e6e2d3; cursor:pointer; }
input[type="checkbox"] { transform: scale(1.2); margin-right:10px; }
.note { font-style:italic; color:#666; margin-left: 10px; font-size: 0.9em; flex-basis: 100%; margin-top: 5px;}
.date { color:#3a7dcb; font-size: 0.9em; margin-left: 10px; font-weight: bold;}
.flag { font-size: 1.2em; margin-left:10px; cursor:pointer; }
.add-item-btn { background:#cfd8d2; font-weight: bold; }
.delete-item-btn { background:#f4b4b4; color: #721c24; margin-left: auto; font-size: 11px; padding: 4px 8px;}

#agenda-container { margin-bottom: 25px; display: none; border-radius: 12px; overflow: hidden; border: 1px solid #ffcc80; }
.agenda-header { background: #fff5e6; padding: 12px 15px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: bold; color: #e67e22; }
#agenda-content { display: none; background: #fffaf0; padding: 15px; border-top: 1px solid #ffcc80; }

.sync-btn { position: fixed; bottom: 25px; right: 25px; width: 60px; height: 60px; border-radius: 50%; background: #4a4a4a; color: white; border: none; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.3); z-index: 10000; font-size: 26px; display: flex; align-items: center; justify-content: center; }
.restore-btn { position: fixed; bottom: 25px; left: 25px; padding: 10px 15px; background: #f4b4b4; color: #721c24; border-radius: 20px; font-size: 12px; font-weight: bold; border: none; cursor: pointer; display: none; z-index: 10000; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
#login-screen { position: fixed; inset: 0; background: #fdfbf5; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 20001; }
</style>
</head>
<body>

<div id="login-screen">
    <h2 style="border:none; cursor:default;">Accesso Planner 2026</h2>
    <input type="password" id="pass-input" placeholder="Inserisci password" style="padding:12px; border-radius:8px; border:1px solid #ccc; width: 220px; text-align: center; font-size:16px;">
    <button onclick="checkLogin()" style="margin-top:15px; padding:12px 40px; background:#4a4a4a; color:white;">ENTRA</button>
</div>

<div id="main-content" style="display:none;">
    <h1>PLANNER 2026</h1>
    
    <div id="agenda-container">
        <div class="agenda-header" onclick="toggleAgenda()">
            <span>üóìÔ∏è Prossimi Appuntamenti</span>
            <span id="agenda-arrow">‚ñº</span>
        </div>
        <div id="agenda-content"></div>
    </div>

    <div id="planner"></div>
</div>

<button class="restore-btn" id="restore-btn" onclick="ripristinaBackup()">‚Ü©Ô∏è Ripristina Backup</button>
<button class="sync-btn" onclick="salvaSuCloud()">‚òÅÔ∏è</button>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzf2V7uR83vAiSN4kMm4IWuSokQG1p8vq9ULZ8rP9KhkJGdrZDW22iR7k0fkMWIp61vdQ/exec";
const PASSWORD_CORRETTA = "Cyborg9001"; // <--- CAMBIALA QUI!

let planner = [
  { titolo:"‚ù§Ô∏è Salute & Corpo", colore:"salute", sottoCategorie:[
      { titolo:"Visite mediche", sottoCategorie:[
          { titolo:"Gastroenterologo (Ortona)", obiettivi:[{testo:"Controllo referto online ASL Abruzzo"},{testo:"Telefonata per risultati"},{testo:"Ricerca / lista gastroenterologi"},{testo:"Note e referti"}] },
          { titolo:"Ginecologo", sottoCategorie:[
              { titolo:"Ricerca specialista", obiettivi:[{testo:"Michele Moncelli"},{testo:"Marina Cortesi"},{testo:"Daniele Mautone (Artemisia)"},{testo:"Carlo De Cicco"},{testo:"Massimiliano Marziali"},{testo:"Manuel Ianieri"}] },
              { titolo:"Temi da approfondire", obiettivi:[{testo:"Endometriosi"},{testo:"Insulino-resistenza"},{testo:"Terapia ormonale (valutazioni)"},{testo:"Dieta per endometriosi"},{testo:"Fertilit√† / salute ovarica"}] },
              { titolo:"Esami da discutere", obiettivi:[{testo:"Trombofilia (pre-terapia ormonale)"},{testo:"Risonanza magnetica pelvica"},{testo:"Marker ovarici CA125"}] },
              { titolo:"Note post-visita", obiettivi:[] },
              { titolo:"Referti", obiettivi:[{testo:"Contattare ASL Lazio ‚Äì esito HPV test"}] }
          ]},
          { titolo:"Urologo", obiettivi:[{testo:"Calcolo renale"},{testo:"Esami / indicazioni"}] },
          { titolo:"Ematologo / Genetista", obiettivi:[{testo:"Esami genetici trombofilia"},{testo:"Familiarit√†"}] },
          { titolo:"Endocrinologo", obiettivi:[{testo:"Visita Ospedale di Atri"},{testo:"Data: 9 marzo"}] },
          { titolo:"Dermatologo", obiettivi:[{testo:"Bolle cutanee ricorrenti"},{testo:"Diagnosi / terapia"}] },
          { titolo:"Senologia", obiettivi:[{testo:"Prima ecografia senologica"},{testo:"Prenotazione entro l‚Äôanno"}] },
          { titolo:"Psicoterapia", obiettivi:[{testo:"Ricerca psicoterapeuta"},{testo:"Bonus psicologico"},{testo:"Avvio percorso terapeutico"}] }
      ]},
      { titolo:"Analisi ed esami", obiettivi:[{testo:"Ferro e ferritina"},{testo:"Marker ovarici CA125"},{testo:"Risonanza magnetica pelvica"}] },
      { titolo:"Fisioterapia & Movimento", sottoCategorie:[
          { titolo:"Fisioterapia prescritta dal fisiatra", obiettivi:[{testo:"Inizio: febbraio"}] },
          { titolo:"Posturale", obiettivi:[] },
          { titolo:"Ripresa attivit√† sportiva", obiettivi:[] }
      ]},
      { titolo:"Estetica & Cura del corpo", sottoCategorie:[
          { titolo:"Capelli", obiettivi:[{testo:"Ricerca salone fidato a Roma"},{testo:"Percorso di cura graduale"},{testo:"Tornare bionda"}] },
          { titolo:"Viso", obiettivi:[{testo:"Filler di rinfresco"},{testo:"Riferimento: Dott.ssa Valentina (Pescara)"}] }
      ]}
  ]},
  { titolo:"üìÖ Vita pratica & Scadenze", colore:"vita", sottoCategorie:[
      { titolo:"Abbonamenti & digitale", obiettivi:[{testo:"Benzina Enilive"},{testo:"Chat Apple"},{testo:"Riduzione iCloud"},{testo:"Backup KDrive"}] },
      { titolo:"Concorsi pubblici", obiettivi:[{testo:"Agenzia delle Entrate"},{testo:"INPS"},{testo:"Comune di Roma"},{testo:"MIC (entro 10 gen)"}] },
      { titolo:"Documenti", obiettivi:[{testo:"Rinnovo patente (marzo)"}] }
  ]},
  { titolo:"üõçÔ∏è Acquisti & Outfit", colore:"acquisti", sottoCategorie:[
      { titolo:"Acquisti graduali 2026", obiettivi:[] },
      { titolo:"Cura capelli", obiettivi:[{testo:"Ricerca spazzole"}] }
  ]},
  { titolo:"üé® Lifestyle / Hobby", colore:"lifestyle", sottoCategorie:[
      { titolo:"Crescita", obiettivi:[{testo:"Eliminare persone nocive"}] },
      { titolo:"Studio", obiettivi:[{testo:"AI"},{testo:"ML"}] }
  ]},
  { titolo:"‚úàÔ∏è Viaggi / Luoghi", colore:"viaggi", sottoCategorie:[
      { titolo:"Torino", obiettivi:[] },
      { titolo:"Barcellona (febbraio)", obiettivi:[] },
      { titolo:"Abruzzo", obiettivi:[{testo:"Ortona"},{testo:"Museo Barbella"}] }
  ]},
  { titolo:"üß≠ PLANNER LIBERO", colore:"libero", sottoCategorie:[
      { titolo:"Spazio aperto", obiettivi:[] }
  ]}
];

function checkLogin() {
    if(document.getElementById('pass-input').value === PASSWORD_CORRETTA) {
        localStorage.setItem('auth_2026', 'true');
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('main-content').style.display = 'block';
        caricaDaCloud();
    } else { alert("Password errata!"); }
}

if(localStorage.getItem('auth_2026') === 'true') {
    document.getElementById('login-screen').style.display = 'none';
    document.getElementById('main-content').style.display = 'block';
}

function toggleAgenda() {
    const content = document.getElementById('agenda-content');
    const arrow = document.getElementById('agenda-arrow');
    const isOpen = content.style.display === 'block';
    content.style.display = isOpen ? 'none' : 'block';
    arrow.textContent = isOpen ? '‚ñº' : '‚ñ≤';
}

function parseDataItaliana(str) {
    if (!str) return 0;
    const match = str.match(/(\d{1,2})\/(\d{1,2})\/(\d{4})/);
    if (match) return new Date(match[3], match[2] - 1, match[1]).getTime();
    const mesi = ["gen", "feb", "mar", "apr", "mag", "giu", "lug", "ago", "set", "ott", "nov", "dic"];
    const parts = str.toLowerCase().split(' ');
    let giorno = parseInt(parts[0]) || 1;
    let mese = mesi.findIndex(m => parts[1] && parts[1].startsWith(m));
    if (mese === -1) mese = 0;
    return new Date(2026, mese, giorno).getTime();
}

function aggiornaAgenda() {
    const container = document.getElementById('agenda-container');
    const content = document.getElementById('agenda-content');
    let scadenze = [];
    const cerca = (lista) => {
        lista.forEach(c => {
            if(c.obiettivi) c.obiettivi.forEach(o => { if(o.data) scadenze.push({...o, cat: c.titolo}); });
            if(c.sottoCategorie) cerca(c.sottoCategorie);
        });
    };
    cerca(planner);
    if(scadenze.length > 0) {
        container.style.display = "block";
        content.innerHTML = "";
        scadenze.sort((a,b) => parseDataItaliana(a.data) - parseDataItaliana(b.data)).forEach(s => {
            content.innerHTML += `<div style="margin-bottom:8px; font-size:0.9em; border-bottom:1px dashed #ccc; padding-bottom:4px;"><strong>${s.data}</strong>: ${s.testo} <br><small style="color:gray;">(${s.cat})</small></div>`;
        });
    } else { container.style.display = "none"; }
}

function checkBackupStatus() {
    const btn = document.getElementById('restore-btn');
    btn.style.display = localStorage.getItem('planner_backup') ? 'block' : 'none';
}

function ripristinaBackup() {
    if(confirm("Vuoi ripristinare l'ultima copia di sicurezza? Perderai le modifiche attuali.")) {
        const backup = localStorage.getItem('planner_backup');
        if(backup) {
            planner = JSON.parse(backup);
            salvaPlanner(); renderizzaTutto();
            alert("Backup ripristinato con successo!");
        }
    }
}

if(localStorage.getItem('planner')) {
    try { planner = JSON.parse(localStorage.getItem('planner')); } catch(e){ console.error(e); }
}

function salvaPlanner() { 
    localStorage.setItem('planner', JSON.stringify(planner)); 
    aggiornaAgenda();
    checkBackupStatus();
}

function renderizzaTutto() {
    const p = document.getElementById('planner');
    p.innerHTML = '';
    creaListaRec(planner, p);
    aggiornaAgenda();
    checkBackupStatus();
}

function creaListaRec(arr, container, livello=2){
  arr.forEach((item, i) => {
    const h = document.createElement('h'+livello);
    h.classList.add('collapsible');
    if(livello===2 && item.colore) h.dataset.color = item.colore;
    
    const spanT = document.createElement('span');
    spanT.className = 'title-text';
    spanT.textContent = item.titolo;
    h.appendChild(spanT);
    
    const bDelCat = document.createElement('button');
    bDelCat.textContent = 'üóëÔ∏è'; bDelCat.className = 'delete-cat-btn';
    bDelCat.onclick = (e) => { e.stopPropagation(); if(confirm("Eliminare intera sezione?")){ arr.splice(i,1); salvaPlanner(); renderizzaTutto(); } };
    h.appendChild(bDelCat);
    
    container.appendChild(h);

    const ul = document.createElement('ul');
    ul.classList.add('collapsible-content');

    (item.obiettivi || []).forEach((obj, j) => {
      if (typeof obj === 'string') { obj = { testo: obj, completato: false, nota: "", data: "", flag: false }; item.obiettivi[j] = obj; }
      const li = document.createElement('li');
      const check = document.createElement('input'); check.type = 'checkbox'; check.checked = obj.completato || false;
      check.onchange = () => { obj.completato = check.checked; salvaPlanner(); };
      li.appendChild(check);

      const txt = document.createElement('span'); txt.textContent = obj.testo; li.appendChild(txt);

      const f = document.createElement('span'); f.className = 'flag'; f.textContent = obj.flag ? '‚úÖ' : 'üî¥';
      f.onclick = () => { obj.flag = !obj.flag; salvaPlanner(); renderizzaTutto(); };
      li.appendChild(f);

      const bD = document.createElement('button'); bD.textContent = 'üìÖ';
      bD.onclick = () => { const res = prompt('Data:', obj.data || ""); if(res !== null) { obj.data = res; salvaPlanner(); renderizzaTutto(); } };
      li.appendChild(bD);

      const bN = document.createElement('button'); bN.textContent = 'üìù';
      bN.onclick = () => { const res = prompt('Nota:', obj.nota || ""); if(res !== null) { obj.nota = res; salvaPlanner(); renderizzaTutto(); } };
      li.appendChild(bN);

      const bDel = document.createElement('button'); bDel.textContent = 'X'; bDel.className = 'delete-item-btn';
      bDel.onclick = () => { item.obiettivi.splice(j, 1); salvaPlanner(); renderizzaTutto(); };
      li.appendChild(bDel);

      if(obj.data) { const sD = document.createElement('span'); sD.className = 'date'; sD.textContent = ' ‚è≥ ' + obj.data; li.appendChild(sD); }
      if(obj.nota) { const sN = document.createElement('div'); sN.className = 'note'; sN.textContent = 'üìù ' + obj.nota; li.appendChild(sN); }
      ul.appendChild(li);
    });

    const divAdd = document.createElement('div');
    const bAddObj = document.createElement('button'); bAddObj.textContent = '+ Obiettivo'; bAddObj.className = 'add-item-btn';
    bAddObj.onclick = () => { const n = prompt('Nuovo obiettivo:'); if(n) { item.obiettivi.push({testo: n, completato: false, nota:"", data:"", flag:false}); salvaPlanner(); renderizzaTutto(); } };
    
    const bAddSub = document.createElement('button'); bAddSub.textContent = '+ Sezione'; bAddSub.className = 'add-item-btn';
    bAddSub.onclick = () => { const n = prompt('Nome sezione:'); if(n) { item.sottoCategorie = item.sottoCategorie || []; item.sottoCategorie.push({titolo: n, obiettivi: [], sottoCategorie: []}); salvaPlanner(); renderizzaTutto(); } };

    divAdd.appendChild(bAddObj); divAdd.appendChild(bAddSub);
    ul.appendChild(divAdd);

    if(item.sottoCategorie) creaListaRec(item.sottoCategorie, ul, livello+1);
    container.appendChild(ul);
  });
}

renderizzaTutto();

document.addEventListener('click', e => {
  const target = e.target.closest('.collapsible');
  if(target){
    const nextUl = target.nextElementSibling;
    if(nextUl) nextUl.style.display = nextUl.style.display==='block' ? 'none' : 'block';
  }
});

async function salvaSuCloud() {
    const btn = document.querySelector('.sync-btn'); btn.textContent = "‚è≥";
    localStorage.setItem('planner_backup', JSON.stringify(planner));
    checkBackupStatus();
    
    try {
        await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(planner) });
        alert("‚úÖ Sincronizzato!");
    } catch (e) { alert("‚ùå Errore sincronizzazione"); }
    btn.textContent = "‚òÅÔ∏è";
}

async function caricaDaCloud() {
    try {
        const response = await fetch(SCRIPT_URL);
        const text = await response.text();
        if (text && text.length > 50) {
            planner = JSON.parse(text);
            salvaPlanner(); renderizzaTutto();
        }
    } catch (e) { console.log("Cloud vuoto o errore"); }
}
if(localStorage.getItem('auth_2026') === 'true') caricaDaCloud();
</script>
</body>
</html>
